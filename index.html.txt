<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seans Notu</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { --bg:#0b0c10; --card:#12131a; --txt:#f2f3f5; --muted:#a9abb7; --b:#2a2c38; --acc:#2a2fff; }
    *{box-sizing:border-box;font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    body{margin:0;background:linear-gradient(180deg,#0b0c10,#07080b);color:var(--txt); }
    header{padding:18px 16px;border-bottom:1px solid var(--b);position:sticky;top:0;background:rgba(11,12,16,.92);backdrop-filter: blur(8px);z-index:10}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns: 1fr 1fr;} }
    .card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:14px;box-shadow: 0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--b);
      background:#0e0f15; color:var(--txt); outline:none;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.35}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > * {flex:1}
    .btn{
      padding:12px 12px; border-radius:12px; border:1px solid var(--b);
      background:#151725; color:var(--txt); cursor:pointer; font-weight:700;
    }
    .btn.primary{background:var(--acc);border-color:var(--acc)}
    .btn.danger{background:#35141a;border-color:#5a1f2a}
    .btn:active{transform: translateY(1px)}
    .muted{color:var(--muted);font-size:12px;line-height:1.4}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--b);border-radius:14px;padding:12px;background:#0e0f15}
    .item h3{margin:0 0 6px;font-size:14px}
    .item .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    pre{
      margin:10px 0 0; white-space:pre-wrap; word-wrap:break-word;
      background:#0b0c10;border:1px solid var(--b); border-radius:12px; padding:10px; color:#e9e9ef;
      font-size:12px; line-height:1.35;
    }
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#10121b;border:1px solid var(--b);
      padding:10px 12px;border-radius:999px;font-size:13px;color:var(--txt);display:none;z-index:999}
    .hr{height:1px;background:var(--b);margin:10px 0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0e0f15;border:1px solid var(--b);font-size:12px;color:var(--muted)}
    .small{font-size:12px}
    .twoBtns{display:flex;gap:10px;flex-wrap:wrap}
    .hint{border:1px dashed var(--b);border-radius:14px;padding:10px;background:#0b0c10}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--b);background:#0e0f15;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{background:#151725;color:var(--txt);border-color:#3b3d50}
    .hide{display:none}
  </style>
</head>
<body>
<header>
  <div class="row" style="gap:12px">
    <div style="flex:2">
      <h1>Seans Notu (Uygulama)</h1>
      <div class="muted">KayÄ±tlar cihazÄ±nda saklanÄ±r. Prompt Ã¼retir, Word indirir, PDF iÃ§in yazdÄ±rÄ±r.</div>
    </div>
    <div style="flex:1;display:flex;justify-content:flex-end;gap:10px;align-items:center">
      <span class="pill" id="installHint">ğŸ“² Ana ekrana eklenebilir</span>
      <button class="btn" id="exportBtn">Yedekle (JSON)</button>
    </div>
  </div>

  <div class="tabs" style="margin-top:12px">
    <button class="tab active" data-tab="daily">GÃ¼nlÃ¼k Seans</button>
    <button class="tab" data-tab="report">Rapor / Ã‡Ä±ktÄ±</button>
    <button class="tab" data-tab="settings">Ayarlar</button>
  </div>
</header>

<main>

  <!-- TAB: GÃ¼nlÃ¼k Seans -->
  <section id="tab-daily" class="grid">
    <section class="card">
      <div class="row">
        <div>
          <label>Ã–ÄŸrenci</label>
          <select id="studentSelect"></select>
        </div>
        <div>
          <label>Tarih</label>
          <input id="dateInput" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Yeni Ã¶ÄŸrenci ekle</label>
          <input id="newStudentInput" placeholder="Ã–rn: Ege" />
        </div>
        <div style="flex:0.7">
          <label>&nbsp;</label>
          <button class="btn" id="addStudentBtn">Ekle</button>
        </div>
        <div style="flex:0.7">
          <label>&nbsp;</label>
          <button class="btn danger" id="removeStudentBtn">Sil</button>
        </div>
      </div>

      <label>Ã‡alÄ±ÅŸÄ±lan konular (madde madde)</label>
      <textarea id="topicsInput" placeholder="- Dikkat egzersizleri&#10;- Ã‡alÄ±ÅŸma belleÄŸi&#10;- OkuduÄŸunu anlama"></textarea>

      <label>KÄ±sa gÃ¶zlem</label>
      <textarea id="obsInput" placeholder="Ã–rn: Dikkatini sÃ¼rdÃ¼rme sÃ¼resi arttÄ±; yÃ¶nerge takibinde zaman zaman tekrar ihtiyacÄ± oldu."></textarea>

      <label>Bir sonraki odak / hedef</label>
      <textarea id="nextInput" placeholder="Ã–rn: DÃ¼rtÃ¼ kontrolÃ¼ ve bekleme; metin anlama iÃ§in 5N1K."></textarea>

      <div class="twoBtns" style="margin-top:12px">
        <button class="btn primary" id="saveBtn">Kaydet</button>
        <button class="btn" id="makePromptBtn">GÃ¼nlÃ¼k Prompt OluÅŸtur + Kopyala</button>
        <button class="btn" id="clearBtn">Temizle</button>
      </div>

      <div class="hr"></div>
      <div class="hint">
        <div class="muted">
          <b>Not:</b> â€œGÃ¼nlÃ¼k Promptâ€, senin burada yazdÄ±ÄŸÄ±n ham veriyi ChatGPTâ€™ye tek seferde verip
          <b>akademik + samimi + Ã¶zgÃ¼n</b> bir seans notu alman iÃ§in hazÄ±rlanÄ±r.
        </div>
      </div>
    </section>

    <section class="cardigregid="report" class="card">
      <div class="row">
        <div>
          <label>Arama</label>
          <input id="searchInput" placeholder="Ã–ÄŸrenci adÄ± / tarih ara (Ã¶rn: 2025-12)" />
        </div>
        <div style="flex:0.8">
          <label>SÄ±ralama</label>
          <select id="sortSelect">
            <option value="new">En yeni</option>
            <option value="old">En eski</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="muted small" id="countInfo"></div>
        <div style="display:flex;justify-content:flex-end;gap:10px">
          <button class="btn" id="importBtn">Ä°Ã§e Aktar</button>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn danger" id="wipeBtn">TÃ¼mÃ¼nÃ¼ Sil</button>
        </div>
      </div>

      <div class="list" id="sessionList"></div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <h2 style="margin:0 0 8px;font-size:16px">GÃ¼nlÃ¼k Prompt Ã–nizlemesi</h2>
      <div class="muted">â€œGÃ¼nlÃ¼k Prompt OluÅŸtur + Kopyalaâ€ dediÄŸinde buradaki metin panoya kopyalanÄ±r.</div>
      <pre id="promptPreview" style="margin-top:10px"></pre>
    </section>
  </section>

  <!-- TAB: Rapor / Ã‡Ä±ktÄ± -->
  <section id="tab-report" class="hide">
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px">Rapor / Ã‡Ä±ktÄ± (Ã–ÄŸrenci + Tarih AralÄ±ÄŸÄ±)</h2>
      <div class="muted">Buradan seÃ§tiÄŸin aralÄ±ktaki seanslarÄ± tek promptta toparlayabilir veya Word Ã§Ä±ktÄ±sÄ± indirebilirsin.</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Ã–ÄŸrenci</label>
          <select id="reportStudentSelect"></select>
        </div>
        <div>
          <label>BaÅŸlangÄ±Ã§</label>
          <input id="fromDate" type="date" />
        </div>
        <div>
          <label>BitiÅŸ</label>
          <input id="toDate" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rapor tipi</label>
          <select id="reportType">
            <option value="weekly">HaftalÄ±k Ã¶zet</option>
            <option value="monthly">AylÄ±k Ã¶zet</option>
            <option value="progress">GeliÅŸim deÄŸerlendirmesi</option>
            <option value="raw">Ham kayÄ±t dÃ¶kÃ¼mÃ¼</option>
          </select>
        </div>
        <div>
          <label>Ton</label>
          <select id="reportTone">
            <option value="acad">Akademik + samimi</option>
            <option value="moreAcad">Daha akademik</option>
            <option value="moreWarm">Daha samimi</option>
          </select>
        </div>
        <div>
          <label>Uzunluk</label>
          <select id="reportLen">
            <option value="short">KÄ±sa</option>
            <option value="mid" selected>Orta</option>
            <option value="long">DetaylÄ±</option>
          </select>
        </div>
      </div>

      <div class="twoBtns" style="margin-top:12px">
        <button class="btn primary" id="buildReportPrompt">Rapor Promptu OluÅŸtur + Kopyala</button>
        <button class="btn" id="downloadWord">Word Ä°ndir (.doc)</button>
        <button class="btn" id="printPdf">PDF Ä°Ã§in YazdÄ±r</button>
      </div>

      <div class="hr"></div>
      <div class="hint">
        <div class="muted">
          <b>Word (.doc) notu:</b> Bu Ã§Ä±ktÄ± Wordâ€™de aÃ§Ä±lan â€œHTML tabanlÄ± docâ€ formatÄ±dÄ±r (kolay ve stabil).
          PDF iÃ§in â€œYazdÄ±râ€ ekranÄ±ndan <b>PDF olarak kaydet</b> seÃ§ebilirsin.
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px">Rapor Prompt Ã–nizlemesi</h2>
      <div class="muted">SeÃ§tiÄŸin aralÄ±ÄŸa gÃ¶re otomatik gÃ¼ncellenir.</div>
      <pre id="reportPromptPreview" style="margin-top:10px"></pre>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px">SeÃ§ilen KayÄ±tlar</h2>
      <div class="muted" id="rangeInfo"></div>
      <pre id="rangeDump" style="margin-top:10px"></pre>
    </section>
  </section>

  <!-- TAB: Ayarlar -->
  <section id="tab-settings" class="hide">
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px">Ayarlar</h2>
      <div class="muted">Bu ayarlar cihazÄ±nda saklanÄ±r.</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>VarsayÄ±lan prompt dili</label>
          <select id="langSelect">
            <option value="tr" selected>TÃ¼rkÃ§e</option>
            <option value="tr2">TÃ¼rkÃ§e (daha kÄ±sa)</option>
          </select>
        </div>
        <div>
          <label>GÃ¼nlÃ¼k promptta â€œtek paragrafâ€ kuralÄ±</label>
          <select id="onePara">
            <option value="yes" selected>Evet</option>
            <option value="no">HayÄ±r</option>
          </select>
        </div>
        <div>
          <label>Word Ã§Ä±ktÄ±sÄ±nda yazÄ± tipi</label>
          <select id="wordFont">
            <option value="Times New Roman" selected>Times New Roman</option>
            <option value="Calibri">Calibri</option>
            <option value="Arial">Arial</option>
          </select>
        </div>
      </div>

      <div class="twoBtns" style="margin-top:12px">
        <button class="btn primary" id="saveSettings">AyarlarÄ± Kaydet</button>
        <button class="btn" id="resetSettings">SÄ±fÄ±rla</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px">KullanÄ±m</h2>
      <div class="muted">
        - Android/Chrome: MenÃ¼ â†’ <b>Ana ekrana ekle</b><br>
        - iPhone/iPad Safari: PaylaÅŸ â†’ <b>Home Screenâ€™e Ekle</b><br>
        - Yedek almayÄ± unutma (JSON). Telefon deÄŸiÅŸince iÃ§e aktarabilirsin.
      </div>
    </section>
  </section>

</main>

<div class="toast" id="toast"></div>

<script>
  // --- PWA SW kaydÄ± ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
  }

  // --- State ---
  const LS_KEY = 'seansnotu_v2';
  const SETTINGS_KEY = 'seansnotu_settings_v1';

  const defaultState = {
    students: ["Ã–ÄŸrenci SeÃ§"],
    sessions: [] // {id, student, date, topics, obs, next}
  };

  const defaultSettings = {
    lang: "tr",
    onePara: "yes",
    wordFont: "Times New Roman"
  };

  function loadState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return structuredClone(defaultState);
      const st = JSON.parse(raw);
      if (!st.students || !st.sessions) return structuredClone(defaultState);
      return st;
    } catch {
      return structuredClone(defaultState);
    }
  }

  function saveState(state) {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function loadSettings() {
    try {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return structuredClone(defaultSettings);
      const s = JSON.parse(raw);
      return { ...structuredClone(defaultSettings), ...s };
    } catch {
      return structuredClone(defaultSettings);
    }
  }

  function saveSettings(s) {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  const state = loadState();
  let settings = loadSettings();

  // --- UI refs (Daily) ---
  const studentSelect = document.getElementById('studentSelect');
  const reportStudentSelect = document.getElementById('reportStudentSelect');
  const dateInput = document.getElementById('dateInput');
  const newStudentInput = document.getElementById('newStudentInput');
  const addStudentBtn = document.getElementById('addStudentBtn');
  const removeStudentBtn = document.getElementById('removeStudentBtn');

  const topicsInput = document.getElementById('topicsInput');
  const obsInput = document.getElementById('obsInput');
  const nextInput = document.getElementById('nextInput');

  const saveBtn = document.getElementById('saveBtn');
  const makePromptBtn = document.getElementById('makePromptBtn');
  const clearBtn = document.getElementById('clearBtn');

  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const sessionList = document.getElementById('sessionList');
  const countInfo = document.getElementById('countInfo');
  const promptPreview = document.getElementById('promptPreview');

  const toast = document.getElementById('toast');

  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const wipeBtn = document.getElementById('wipeBtn');

  // --- UI refs (Report) ---
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const reportType = document.getElementById('reportType');
  const reportTone = document.getElementById('reportTone');
  const reportLen = document.getElementById('reportLen');
  const buildReportPrompt = document.getElementById('buildReportPrompt');
  const downloadWordBtn = document.getElementById('downloadWord');
  const printPdfBtn = document.getElementById('printPdf');
  const reportPromptPreview = document.getElementById('reportPromptPreview');
  const rangeDump = document.getElementById('rangeDump');
  const rangeInfo = document.getElementById('rangeInfo');

  // --- UI refs (Settings) ---
  const langSelect = document.getElementById('langSelect');
  const onePara = document.getElementById('onePara');
  const wordFont = document.getElementById('wordFont');
  const saveSettingsBtn = document.getElementById('saveSettings');
  const resetSettingsBtn = document.getElementById('resetSettings');

  // --- Tabs ---
  const tabs = document.querySelectorAll('.tab');
  function showTab(key) {
    document.getElementById('tab-daily').classList.toggle('hide', key !== 'daily');
    document.getElementById('tab-report').classList.toggle('hide', key !== 'report');
    document.getElementById('tab-settings').classList.toggle('hide', key !== 'settings');
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
  }
  tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));

  // --- helpers ---
  function todayISO() {
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60*1000);
    return local.toISOString().slice(0,10);
  }

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.style.display = 'none', 1700);
  }

  function normalizeBullets(text) {
    const lines = (text || '').split('\n').map(s => s.trim()).filter(Boolean);
    if (!lines.length) return [];
    return lines.map(l => l.replace(/^[-â€¢\u2022]\s*/, '')).filter(Boolean);
  }

  function escapeHtml(str) {
    return String(str || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      showToast("Panoya kopyalandÄ±.");
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      showToast("Panoya kopyalandÄ±.");
    }
  }

  function countLines(text) {
    return normalizeBullets(text).length || (String(text||'').trim()? 1 : 0);
  }

  // --- CÃ¼mle bankasÄ± (rapor promptuna â€œdeÄŸiÅŸken, Ã¶zgÃ¼nâ€ dil iÃ§in ipucu) ---
  const sentenceBank = {
    participation: [
      "Etkinliklere katÄ±lÄ±m dÃ¼zeyi genel olarak istikrarlÄ± seyretti.",
      "Seans boyunca katÄ±lÄ±mÄ± destekleyen yapÄ±landÄ±rÄ±lmÄ±ÅŸ yÃ¶nergelerden olumlu yararlandÄ±.",
      "ZorlandÄ±ÄŸÄ± anlarda kÄ±sa ipuÃ§larÄ±yla yeniden gÃ¶reve dÃ¶nebildi."
    ],
    attention: [
      "Dikkatini sÃ¼rdÃ¼rme sÃ¼resinde oturum iÃ§inde dalgalanmalar gÃ¶zlendi.",
      "UyarÄ±cÄ± kontrolÃ¼ ve dikkat yÃ¶neltme becerilerinde destekle ilerleme saÄŸlandÄ±.",
      "Dikkat sÃ¼rekliliÄŸini artÄ±rmak amacÄ±yla kÄ±sa, ardÄ±ÅŸÄ±k gÃ¶revler etkili oldu."
    ],
    regulation: [
      "DÃ¼rtÃ¼ kontrolÃ¼ ve bekleme becerilerinde kademeli geliÅŸim izlendi.",
      "SÄ±nÄ±r alma sÃ¼reÃ§lerinde hatÄ±rlatmaya ihtiyaÃ§ duyduÄŸu anlar oldu.",
      "Ã–z dÃ¼zenleme gerektiren gÃ¶revlerde model olma ve pekiÅŸtirme yararlÄ± oldu."
    ],
    progress: [
      "Hedeflenen kazanÄ±mlarda baÅŸlangÄ±Ã§ dÃ¼zeyine gÃ¶re daha iÅŸlevsel yanÄ±tlar gÃ¶zlendi.",
      "Beceri genellemesi iÃ§in tekrar ve farklÄ± baÄŸlamlarda uygulama ihtiyacÄ± sÃ¼rmektedir.",
      "PerformansÄ±nÄ± destekleyen ipuÃ§larÄ± azaltÄ±ldÄ±kÃ§a baÄŸÄ±msÄ±zlÄ±k dÃ¼zeyi artma eÄŸilimindedir."
    ]
  };

  function pick3(arr, seed) {
    // deterministik mini seÃ§im (aynÄ± aralÄ±kta benzer prompt Ã¼retmesin diye)
    const a = [...arr];
    let x = seed || 7;
    a.sort(() => {
      x = (x * 9301 + 49297) % 233280;
      return (x / 233280) - 0.5;
    });
    return a.slice(0,3);
  }

  // --- Prompt builders ---
  function buildDailyPrompt({student, date, topics, obs, next}) {
    const bullets = normalizeBullets(topics);
    const topicsBlock = bullets.length ? bullets.map(b => `- ${b}`).join('\n')
      : (topics || '').trim() ? topics.trim() : "- (konu girilmedi)";

    const obsText = (obs || '').trim() || "(gÃ¶zlem girilmedi)";
    const nextText = (next || '').trim() || "(hedef girilmedi)";

    const oneParaRule = settings.onePara === "yes"
      ? "- MÃ¼mkÃ¼nse tek paragraf yaz; en fazla 2 kÄ±sa paragraf.\n"
      : "- Paragraf yapÄ±sÄ±nÄ± uygun gÃ¶rÃ¼rsen 2-3 paragrafa bÃ¶lebilirsin.\n";

    const langVariant = settings.lang === "tr2"
      ? "Kriterler:\n- Akademik ama samimi.\n- Gereksiz uzatma; net ve akÄ±cÄ±.\n"
      : "Kriterler:\n- Akademik ama samimi bir ton kullan.\n- Ã–zgÃ¼n cÃ¼mleler kur; tekrar eden kalÄ±p ifadelerden kaÃ§Ä±n.\n";

    return `AÅŸaÄŸÄ±daki ham seans verilerini kullanarak TÃ¼rkÃ§e bir â€œGÃ¼nlÃ¼k Seans Notuâ€ yaz.

${langVariant}${oneParaRule}- Ã‡alÄ±ÅŸÄ±lan alanlarÄ± ve gÃ¶zlemleri doÄŸal biÃ§imde bÃ¼tÃ¼nleÅŸtir.
- Son cÃ¼mlede bir sonraki oturum odaÄŸÄ±nÄ±/Ã¶neriyi belirt.
- Ã–ÄŸrenci adÄ± ve tarih metinde geÃ§sin.

HAM VERÄ°:
Ã–ÄŸrenci: ${student}
Tarih: ${date}

Ã‡alÄ±ÅŸÄ±lan Konular:
${topicsBlock}

KÄ±sa GÃ¶zlem:
${obsText}

Bir Sonraki Odak/Hedef:
${nextText}
`;
  }

  function inRange(dateStr, fromStr, toStr) {
    if (!dateStr) return false;
    const d = dateStr;
    if (fromStr && d < fromStr) return false;
    if (toStr && d > toStr) return false;
    return true;
  }

  function getRangeSessions() {
    const s = reportStudentSelect.value;
    const f = fromDate.value;
    const t = toDate.value;
    return state.sessions
      .filter(x => (s === "__ALL__" ? true : x.student === s))
      .filter(x => inRange(x.date, f, t))
      .sort((a,b) => (a.date||'').localeCompare(b.date||''));
  }

  function buildRangeDumpText(list) {
    if (!list.length) return "(SeÃ§ilen aralÄ±kta kayÄ±t yok.)";
    return list.map(x => {
      const bullets = normalizeBullets(x.topics);
      const topics = bullets.length ? bullets.map(b => `- ${b}`).join('\n') : (x.topics||'').trim();
      return `Tarih: ${x.date}
Ã–ÄŸrenci: ${x.student}
Ã‡alÄ±ÅŸÄ±lan Konular:
${topics || "- (boÅŸ)"}
KÄ±sa GÃ¶zlem:
${(x.obs||"").trim() || "(boÅŸ)"}
Bir Sonraki Odak/Hedef:
${(x.next||"").trim() || "(boÅŸ)"}
---`;
    }).join('\n\n');
  }

  function toneText() {
    const v = reportTone.value;
    if (v === "moreAcad") return "Ton: akademik, rapor diline yakÄ±n; duygusal ifadeleri minimal tut.";
    if (v === "moreWarm") return "Ton: samimi, motive edici; akademik tutarlÄ±lÄ±ÄŸÄ± koru.";
    return "Ton: akademik ama samimi; doÄŸal ve profesyonel bir anlatÄ±m.";
  }

  function lenText() {
    const v = reportLen.value;
    if (v === "short") return "Uzunluk: kÄ±sa (5-8 cÃ¼mle).";
    if (v === "long") return "Uzunluk: detaylÄ± (2-4 paragraf, gerektiÄŸinde maddeleme).";
    return "Uzunluk: orta (1-2 paragraf).";
  }

  function reportGoalText() {
    const v = reportType.value;
    if (v === "weekly") return "AmaÃ§: haftalÄ±k seanslarÄ±n genel Ã¶zetini Ã§Ä±kar; Ã¶ne Ã§Ä±kan kazanÄ±mlar ve ihtiyaÃ§lar.";
    if (v === "monthly") return "AmaÃ§: aylÄ±k eÄŸilimleri deÄŸerlendir; geliÅŸim alanlarÄ±, zorlanmalar, Ã¶neriler.";
    if (v === "progress") return "AmaÃ§: geliÅŸim deÄŸerlendirmesi yaz; gÃ¼Ã§lÃ¼ yÃ¶nler, destek gereksinimleri, hedefler.";
    return "AmaÃ§: ham kayÄ±tlarÄ± dÃ¼zenli bir dÃ¶kÃ¼m olarak sun (yorum eklemeden).";
  }

  function buildReportPrompt() {
    const list = getRangeSessions();
    const s = reportStudentSelect.value === "__ALL__" ? "TÃœM Ã–ÄRENCÄ°LER" : reportStudentSelect.value;
    const f = fromDate.value || "(baÅŸlangÄ±Ã§ yok)";
    const t = toDate.value || "(bitiÅŸ yok)";

    const dump = buildRangeDumpText(list);

    if (reportType.value === "raw") {
      return `AÅŸaÄŸÄ±daki â€œSeans KayÄ±tlarÄ±â€ metnini dÃ¼zenle:
- Tarihe gÃ¶re sÄ±ralÄ± kalsÄ±n.
- Her kayÄ±t net baÅŸlÄ±klarla ayrÄ±ÅŸsÄ±n (Tarih / Ã–ÄŸrenci / Konular / GÃ¶zlem / Hedef).
- Yorum ekleme, sadece dÃ¼zenle.

KAPSAM:
Ã–ÄŸrenci: ${s}
Tarih aralÄ±ÄŸÄ±: ${f} â€“ ${t}

SEANS KAYITLARI:
${dump}
`;
    }

    const seed = (list.length * 13) + (f.replaceAll('-','')|0) + (t.replaceAll('-','')|0);
    const hints = [
      ...pick3(sentenceBank.participation, seed),
      ...pick3(sentenceBank.attention, seed+3),
      ...pick3(sentenceBank.regulation, seed+6),
      ...pick3(sentenceBank.progress, seed+9)
    ].slice(0,6);

    return `AÅŸaÄŸÄ±daki seans kayÄ±tlarÄ±nÄ± temel alarak TÃ¼rkÃ§e bir rapor yaz.

${reportGoalText()}
${toneText()}
${lenText()}

YazÄ±m Ã¶lÃ§Ã¼tleri:
- Ã–zgÃ¼n cÃ¼mleler kur; tekrar eden kalÄ±plardan kaÃ§Ä±n.
- Ã‡alÄ±ÅŸÄ±lan alanlarÄ± â€œtemaâ€ bazÄ±nda grupla (Ã¶rn: dikkat, yÃ¼rÃ¼tÃ¼cÃ¼ iÅŸlevler, dil/okuma, matematik, sosyal beceriler).
- GÃ¶zlemleri nesnel bir dille raporla (katÄ±lÄ±m, dikkat, dÃ¼rtÃ¼sellik, yÃ¶nerge takibi, genelleme).
- Son bÃ¶lÃ¼mde 3-5 maddelik â€œÃ–nerilen bir sonraki odaklarâ€ ver.

CÃ¼mle Ã§eÅŸitliliÄŸi iÃ§in yardÄ±mcÄ± ifadeler (zorunlu deÄŸil, ilham):
- ${hints.join("\n- ")}

KAPSAM:
Ã–ÄŸrenci: ${s}
Tarih aralÄ±ÄŸÄ±: ${f} â€“ ${t}

SEANS KAYITLARI (HAM):
${dump}
`;
  }

  // --- Word(.doc) builder (HTML doc) ---
  function buildWordDocHtml(title, bodyHtml) {
    const font = settings.wordFont || "Times New Roman";
    return `<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:${font}, serif; font-size:12pt; line-height:1.35; }
  h1{font-size:16pt; margin:0 0 10pt 0;}
  h2{font-size:13pt; margin:14pt 0 6pt 0;}
  .meta{font-size:11pt; color:#333; margin-bottom:10pt;}
  .box{border:1px solid #ddd; padding:10pt; border-radius:8pt; margin:10pt 0;}
  .muted{color:#444;}
  ul{margin:6pt 0 6pt 18pt;}
  p{margin:6pt 0; text-align:justify;}
  .sep{height:1px;background:#eee;margin:12pt 0;}
</style>
</head>
<body>
${bodyHtml}
</body>
</html>`;
  }

  function sessionsToWordBody(list, scopeTitle) {
    const f = fromDate.value || "";
    const t = toDate.value || "";
    const meta = `${f && t ? `${f} â€“ ${t}` : (f || t ? (f ? `BaÅŸlangÄ±Ã§: ${f}` : `BitiÅŸ: ${t}`) : "Tarih aralÄ±ÄŸÄ±: belirtilmedi")}`;

    const items = list.length ? list.map(x => {
      const bullets = normalizeBullets(x.topics);
      const topicsHtml = bullets.length
        ? `<ul>${bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}</ul>`
        : `<p class="muted">${escapeHtml((x.topics||"").trim() || "(konu yok)")}</p>`;

      const obs = (x.obs||"").trim() || "(gÃ¶zlem yok)";
      const next = (x.next||"").trim() || "(hedef yok)";

      return `
<div class="box">
  <h2>${escapeHtml(x.student)} â€” ${escapeHtml(x.date)}</h2>
  <p><b>Ã‡alÄ±ÅŸÄ±lan Konular:</b></p>
  ${topicsHtml}
  <p><b>KÄ±sa GÃ¶zlem:</b> ${escapeHtml(obs)}</p>
  <p><b>Bir Sonraki Odak/Hedef:</b> ${escapeHtml(next)}</p>
</div>`;
    }).join("\n") : `<p>(SeÃ§ilen aralÄ±kta kayÄ±t yok.)</p>`;

    return `<h1>${escapeHtml(scopeTitle)}</h1>
<div class="meta">${escapeHtml(meta)}</div>
${items}`;
  }

  function downloadFile(filename, content, mime) {
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 800);
  }

  function openPrintWindow(title, htmlBody) {
    const font = settings.wordFont || "Times New Roman";
    const html = `<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:${font}, serif; font-size:12pt; line-height:1.35; padding:18px;}
  h1{font-size:16pt; margin:0 0 10pt 0;}
  h2{font-size:13pt; margin:14pt 0 6pt 0;}
  .meta{font-size:11pt; color:#333; margin-bottom:10pt;}
  .box{border:1px solid #ddd; padding:10pt; border-radius:8pt; margin:10pt 0;}
  ul{margin:6pt 0 6pt 18pt;}
  p{margin:6pt 0; text-align:justify;}
</style>
</head>
<body>
${htmlBody}
</body>
</html>`;
    const w = window.open("", "_blank");
    if (!w) return showToast("Pop-up engellendi.");
    w.document.open();
    w.document.write(html);
    w.document.close();
    w.focus();
    setTimeout(()=>w.print(), 300);
  }

  // --- render ---
  function renderStudents(selectEl, includeAll=false) {
    selectEl.innerHTML = '';
    if (includeAll) {
      const optAll = document.createElement('option');
      optAll.value = "__ALL__";
      optAll.textContent = "TÃ¼mÃ¼";
      selectEl.appendChild(optAll);
    }
    state.students.forEach((s, idx) => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      if (!includeAll && idx === 0) opt.disabled = true;
      if (includeAll && idx === 0) return; // "Ã–ÄŸrenci SeÃ§" raporda gereksiz
      selectEl.appendChild(opt);
    });

    // seÃ§imi koru
    const saved = localStorage.getItem(selectEl.id === "studentSelect" ? 'seansnotu_last_student' : 'seansnotu_last_report_student');
    if (saved && Array.from(selectEl.options).some(o=>o.value===saved)) selectEl.value = saved;
  }

  function filteredSessions() {
    const q = (searchInput.value || '').trim().toLowerCase();
    let list = [...state.sessions];

    if (q) {
      list = list.filter(s =>
        (s.student || '').toLowerCase().includes(q) ||
        (s.date || '').toLowerCase().includes(q)
      );
    }
    const sort = sortSelect.value;
    list.sort((a,b) => sort === 'new'
      ? (b.date || '').localeCompare(a.date || '')
      : (a.date || '').localeCompare(b.date || '')
    );
    return list;
  }

  function renderSessions() {
    const list = filteredSessions();
    countInfo.textContent = `${list.length} kayÄ±t gÃ¶steriliyor (toplam: ${state.sessions.length}).`;
    sessionList.innerHTML = '';

    if (!list.length) {
      sessionList.innerHTML = `<div class="muted">HenÃ¼z kayÄ±t yok. Sol taraftan seans kaydÄ± ekleyebilirsin.</div>`;
      return;
    }

    for (const s of list) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="row" style="gap:10px">
          <div style="flex:2">
            <h3>${escapeHtml(s.student)} <span class="muted">Â· ${escapeHtml(s.date)}</span></h3>
            <div class="meta">
              <span>Konular: ${countLines(s.topics)}</span>
              <span>ID: ${s.id.slice(0,6)}</span>
            </div>
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end;flex:1">
            <button class="btn" data-act="edit" data-id="${s.id}">DÃ¼zenle</button>
            <button class="btn" data-act="copy" data-id="${s.id}">Prompt Kopyala</button>
            <button class="btn danger" data-act="del" data-id="${s.id}">Sil</button>
          </div>
        </div>
        <pre>${escapeHtml(buildDailyPrompt(s))}</pre>
      `;
      sessionList.appendChild(div);
    }
  }

  function setPromptPreview() {
    const student = studentSelect.value;
    const date = dateInput.value || todayISO();
    const prompt = buildDailyPrompt({
      student,
      date,
      topics: topicsInput.value,
      obs: obsInput.value,
      next: nextInput.value
    });
    promptPreview.textContent = prompt;
  }

  function refreshReportPreview() {
    const list = getRangeSessions();
    const f = fromDate.value || "(baÅŸlangÄ±Ã§ yok)";
    const t = toDate.value || "(bitiÅŸ yok)";
    const who = reportStudentSelect.value === "__ALL__" ? "TÃ¼mÃ¼" : reportStudentSelect.value;
    rangeInfo.textContent = `${who} | ${f} â€“ ${t} | ${list.length} kayÄ±t`;

    rangeDump.textContent = buildRangeDumpText(list);
    reportPromptPreview.textContent = buildReportPrompt();
  }

  // --- init ---
  dateInput.value = todayISO();

  // rapor tarihleri iÃ§in: son 7 gÃ¼n varsayÄ±lan
  const today = todayISO();
  toDate.value = today;
  const d = new Date();
  d.setDate(d.getDate() - 7);
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off*60*1000);
  fromDate.value = local.toISOString().slice(0,10);

  // settings UI init
  langSelect.value = settings.lang;
  onePara.value = settings.onePara;
  wordFont.value = settings.wordFont;

  renderStudents(studentSelect, false);
  renderStudents(reportStudentSelect, true);

  if (state.students.length === 1) {
    state.students.push("Ege","Serra","Nil","Berk");
    saveState(state);
    renderStudents(studentSelect, false);
    renderStudents(reportStudentSelect, true);
  }

  setPromptPreview();
  renderSessions();
  refreshReportPreview();

  // --- events (Daily) ---
  studentSelect.addEventListener('change', () => {
    localStorage.setItem('seansnotu_last_student', studentSelect.value);
    setPromptPreview();
  });

  [dateInput, topicsInput, obsInput, nextInput].forEach(el => el.addEventListener('input', setPromptPreview));

  addStudentBtn.addEventListener('click', () => {
    const name = (newStudentInput.value || '').trim();
    if (!name) return showToast("Ã–ÄŸrenci adÄ± yaz.");
    if (state.students.includes(name)) return showToast("Bu Ã¶ÄŸrenci zaten var.");
    state.students.push(name);
    saveState(state);
    newStudentInput.value = '';
    renderStudents(studentSelect, false);
    renderStudents(reportStudentSelect, true);
    studentSelect.value = name;
    localStorage.setItem('seansnotu_last_student', name);
    showToast("Ã–ÄŸrenci eklendi.");
    setPromptPreview();
  });

  removeStudentBtn.addEventListener('click', () => {
    const s = studentSelect.value;
    if (!s || s === "Ã–ÄŸrenci SeÃ§") return showToast("Silinecek Ã¶ÄŸrenci seÃ§.");
    state.students = state.students.filter(x => x !== s);
    saveState(state);
    renderStudents(studentSelect, false);
    renderStudents(reportStudentSelect, true);
    studentSelect.value = "Ã–ÄŸrenci SeÃ§";
    showToast("Ã–ÄŸrenci silindi.");
    setPromptPreview();
  });

  saveBtn.addEventListener('click', () => {
    const student = studentSelect.value;
    if (!student || student === "Ã–ÄŸrenci SeÃ§") return showToast("Ã–ÄŸrenci seÃ§.");
    const date = dateInput.value || todayISO();

    const entry = { id: uid(), student, date, topics: topicsInput.value, obs: obsInput.value, next: nextInput.value };
    state.sessions.push(entry);
    saveState(state);
    renderSessions();
    refreshReportPreview();
    showToast("KayÄ±t eklendi.");
  });

  clearBtn.addEventListener('click', () => {
    topicsInput.value = '';
    obsInput.value = '';
    nextInput.value = '';
    setPromptPreview();
    showToast("Temizlendi.");
  });

  makePromptBtn.addEventListener('click', async () => {
    const student = studentSelect.value;
    if (!student || student === "Ã–ÄŸrenci SeÃ§") return showToast("Ã–ÄŸrenci seÃ§.");
    await copyText(promptPreview.textContent);
  });

  searchInput.addEventListener('input', renderSessions);
  sortSelect.addEventListener('change', renderSessions);

  sessionList.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    const idx = state.sessions.findIndex(x => x.id === id);
    if (idx < 0) return;
    const s = state.sessions[idx];

    if (act === 'del') {
      state.sessions.splice(idx,1);
      saveState(state);
      renderSessions();
      refreshReportPreview();
      showToast("Silindi.");
    } else if (act === 'edit') {
      if (!state.students.includes(s.student)) state.students.push(s.student);
      saveState(state);
      renderStudents(studentSelect, false);
      renderStudents(reportStudentSelect, true);
      studentSelect.value = s.student;
      dateInput.value = s.date;
      topicsInput.value = s.topics || '';
      obsInput.value = s.obs || '';
      nextInput.value = s.next || '';
      setPromptPreview();
      showToast("DÃ¼zenleme iÃ§in forma yÃ¼klendi.");
    } else if (act === 'copy') {
      await copyText(buildDailyPrompt(s));
    }
  });

  // --- backup import/export ---
  exportBtn.addEventListener('click', async () => {
    const data = JSON.stringify({ state, settings }, null, 2);
    const name = `seansnotu_yedek_${todayISO()}.json`;
    downloadFile(name, data, 'application/json');
    showToast("Yedek indirildi.");
  });

  importBtn.addEventListener('click', () => importFile.click());
  importFile.addEventListener('change', async () => {
    const file = importFile.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const incoming = JSON.parse(text);

      // esnek: eski yedekler sadece state olabilir
      const incomingState = incoming.state ? incoming.state : incoming;
      const incomingSettings = incoming.settings ? incoming.settings : null;

      if (!incomingState.students || !incomingState.sessions) throw new Error("format");

      const mergedStudents = Array.from(new Set([...state.students, ...incomingState.students]));
      const mergedSessions = [...state.sessions, ...incomingState.sessions].map(s => ({
        id: s.id || uid(),
        student: s.student || "Bilinmiyor",
        date: s.date || todayISO(),
        topics: s.topics || "",
        obs: s.obs || "",
        next: s.next || ""
      }));

      state.students = mergedStudents;
      state.sessions = mergedSessions;

      if (incomingSettings) {
        settings = { ...settings, ...incomingSettings };
        saveSettings(settings);
        langSelect.value = settings.lang;
        onePara.value = settings.onePara;
        wordFont.value = settings.wordFont;
      }

      saveState(state);
      renderStudents(studentSelect, false);
      renderStudents(reportStudentSelect, true);
      renderSessions();
      refreshReportPreview();
      showToast("Ä°Ã§e aktarÄ±ldÄ±.");
    } catch {
      showToast("Ä°Ã§e aktarma baÅŸarÄ±sÄ±z (JSON).");
    } finally {
      importFile.value = '';
    }
  });

  wipeBtn.addEventListener('click', () => {
    if (!confirm("TÃ¼m kayÄ±tlar silinsin mi?")) return;
    state.students = ["Ã–ÄŸrenci SeÃ§"];
    state.sessions = [];
    saveState(state);
    renderStudents(studentSelect, false);
    renderStudents(reportStudentSelect, true);
    renderSessions();
    refreshReportPreview();
    setPromptPreview();
    showToast("TÃ¼mÃ¼ silindi.");
  });

  // --- Report events ---
  [reportStudentSelect, fromDate, toDate, reportType, reportTone, reportLen].forEach(el => {
    el.addEventListener('change', () => {
      if (el === reportStudentSelect) localStorage.setItem('seansnotu_last_report_student', reportStudentSelect.value);
      refreshReportPreview();
    });
    el.addEventListener('input', refreshReportPreview);
  });

  buildReportPrompt.addEventListener('click', async () => {
    const prompt = buildReportPrompt();
    await copyText(prompt);
  });

  downloadWordBtn.addEventListener('click', () => {
    const list = getRangeSessions();
    const who = reportStudentSelect.value === "__ALL__" ? "Tum_Ogrenciler" : reportStudentSelect.value;
    const f = fromDate.value || "baslangicYok";
    const t = toDate.value || "bitisYok";
    const title = `Seans_Dokumu_${who}_${f}_${t}`;
    const body = sessionsToWordBody(list, "Seans DÃ¶kÃ¼mÃ¼");
    const doc = buildWordDocHtml(title, body);
    downloadFile(`${title}.doc`, doc, 'application/msword');
    showToast("Word indirildi.");
  });

  printPdfBtn.addEventListener('click', () => {
    const list = getRangeSessions();
    const who = reportStudentSelect.value === "__ALL__" ? "TÃ¼m Ã–ÄŸrenciler" : reportStudentSelect.value;
    const body = sessionsToWordBody(list, `Seans DÃ¶kÃ¼mÃ¼ â€” ${who}`);
    openPrintWindow("Seans DÃ¶kÃ¼mÃ¼", body);
  });

  // --- Settings events ---
  saveSettingsBtn.addEventListener('click', () => {
    settings.lang = langSelect.value;
    settings.onePara = onePara.value;
    settings.wordFont = wordFont.value;
    saveSettings(settings);
    setPromptPreview();
    refreshReportPreview();
    showToast("Ayarlar kaydedildi.");
  });

  resetSettingsBtn.addEventListener('click', () => {
    settings = structuredClone(defaultSettings);
    saveSettings(settings);
    langSelect.value = settings.lang;
    onePara.value = settings.onePara;
    wordFont.value = settings.wordFont;
    setPromptPreview();
    refreshReportPreview();
    showToast("Ayarlar sÄ±fÄ±rlandÄ±.");
  });

  // ilk aÃ§Ä±lÄ±ÅŸ rapor Ã¶nizleme
  refreshReportPreview();
</script>
</body>
</html>
