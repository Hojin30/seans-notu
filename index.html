<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seans Notu</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{--bg:#0b0c10;--card:#12131a;--txt:#f2f3f5;--muted:#a9abb7;--b:#2a2c38;--acc:#2a2fff}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#0b0c10,#07080b);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,12,16,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--b);padding:14px 14px}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:12px;line-height:1.4}
    main{max-width:980px;margin:0 auto;padding:14px;display:grid;gap:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--b);background:#0e0f15;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{background:#151725;color:var(--txt);border-color:#3b3d50}
    .grid{display:grid;gap:12px}
    @media(min-width:920px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--b);background:#0e0f15;color:var(--txt);outline:none}
    textarea{min-height:110px;resize:vertical;line-height:1.35}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .btn{padding:12px;border-radius:12px;border:1px solid var(--b);background:#151725;color:var(--txt);cursor:pointer;font-weight:800}
    .btn.primary{background:var(--acc);border-color:var(--acc)}
    .btn.danger{background:#35141a;border-color:#5a1f2a}
    .btn:active{transform:translateY(1px)}
    .twoBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .hide{display:none}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{background:#0e0f15;border:1px solid var(--b);border-radius:14px;padding:12px}
    .item h3{margin:0 0 6px;font-size:14px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    pre{margin:10px 0 0;white-space:pre-wrap;background:#0b0c10;border:1px solid var(--b);border-radius:12px;padding:10px;font-size:12px}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#10121b;border:1px solid var(--b);
      padding:10px 12px;border-radius:999px;font-size:13px;color:var(--txt);display:none;z-index:999}
  </style>
</head>
<body>
<header>
  <h1>Seans Notu</h1>
  <div class="muted">Kayıtlar cihazında saklanır. Prompt üretir, Word indirir, PDF için yazdırır.</div>

  <div class="tabs">
    <button class="tab active" data-tab="daily">Günlük</button>
    <button class="tab" data-tab="report">Rapor/Çıktı</button>
    <button class="tab" data-tab="backup">Yedek</button>
  </div>
</header>

<main>
  <!-- Günlük -->
  <section id="daily" class="grid">
    <section class="card">
      <div class="row">
        <div>
          <label>Öğrenci</label>
          <select id="student"></select>
        </div>
        <div>
          <label>Tarih</label>
          <input id="date" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Yeni öğrenci ekle</label>
          <input id="newStudent" placeholder="Örn: Ege">
        </div>
        <div style="flex:.6">
          <label>&nbsp;</label>
          <button class="btn" id="addStudent">Ekle</button>
        </div>
        <div style="flex:.6">
          <label>&nbsp;</label>
          <button class="btn danger" id="delStudent">Sil</button>
        </div>
      </div>

      <label>Çalışılan konular (madde madde)</label>
      <textarea id="topics" placeholder="- Dikkat egzersizleri&#10;- Okuduğunu anlama"></textarea>

      <label>Kısa gözlem</label>
      <textarea id="obs" placeholder="Örn: Dikkatini sürdürme süresi arttı..."></textarea>

      <label>Bir sonraki odak / hedef</label>
      <textarea id="next" placeholder="Örn: Dürtü kontrolü, bekleme..."></textarea>

      <div class="twoBtns">
        <button class="btn primary" id="save">Kaydet</button>
        <button class="btn" id="copyDaily">Günlük Prompt Kopyala</button>
        <button class="btn" id="clear">Temizle</button>
      </div>

      <label>Günlük Prompt Önizleme</label>
      <pre id="dailyPreview"></pre>
    </section>

    <section class="card">
      <div class="row">
        <div>
          <label>Arama</label>
          <input id="search" placeholder="Örn: Ege veya 2025-12">
        </div>
        <div style="flex:.8">
          <label>Sıralama</label>
          <select id="sort">
            <option value="new">En yeni</option>
            <option value="old">En eski</option>
          </select>
        </div>
      </div>

      <div class="muted" id="count"></div>
      <div class="list" id="list"></div>
    </section>
  </section>

  <!-- Rapor -->
  <section id="report" class="hide">
    <section class="card">
      <div class="row">
        <div>
          <label>Öğrenci</label>
          <select id="rStudent"></select>
        </div>
        <div>
          <label>Başlangıç</label>
          <input id="from" type="date">
        </div>
        <div>
          <label>Bitiş</label>
          <input id="to" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rapor tipi</label>
          <select id="rType">
            <option value="weekly">Haftalık özet</option>
            <option value="monthly">Aylık özet</option>
            <option value="progress">Gelişim değerlendirmesi</option>
            <option value="raw">Ham döküm</option>
          </select>
        </div>
        <div>
          <label>Uzunluk</label>
          <select id="rLen">
            <option value="short">Kısa</option>
            <option value="mid" selected>Orta</option>
            <option value="long">Detaylı</option>
          </select>
        </div>
      </div>

      <div class="twoBtns">
        <button class="btn primary" id="copyReport">Rapor Prompt Kopyala</button>
        <button class="btn" id="downloadDoc">Word İndir (.doc)</button>
        <button class="btn" id="print">PDF için Yazdır</button>
      </div>

      <label>Rapor Prompt Önizleme</label>
      <pre id="reportPreview"></pre>
    </section>

    <section class="card">
      <div class="muted" id="rangeInfo"></div>
      <label>Seçilen Kayıt Dökümü</label>
      <pre id="dump"></pre>
    </section>
  </section>

  <!-- Yedek -->
  <section id="backup" class="hide">
    <section class="card">
      <div class="twoBtns">
        <button class="btn primary" id="export">Yedek indir (JSON)</button>
        <button class="btn" id="importBtn">Yedek içe aktar</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="btn danger" id="wipe">Tüm veriyi sil</button>
      </div>
      <div class="muted" style="margin-top:10px">
        Telefon değiştirirken JSON yedeğini indirip yeni telefonda içe aktarabilirsin.
      </div>
    </section>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
(() => {
  // SW kayıt
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
  }

  const LS = 'seansnotu_clean_v1';
  const state = load() || { students: ['Öğrenci Seç','Ege','Serra','Nil','Berk'], sessions: [] };

  // refs
  const $ = (id)=>document.getElementById(id);
  const tabs = document.querySelectorAll('.tab');

  const student = $('student'), date = $('date'), newStudent=$('newStudent');
  const topics=$('topics'), obs=$('obs'), next=$('next');
  const dailyPreview=$('dailyPreview');
  const saveBtn=$('save'), copyDaily=$('copyDaily'), clearBtn=$('clear');
  const addStudent=$('addStudent'), delStudent=$('delStudent');

  const search=$('search'), sort=$('sort'), list=$('list'), count=$('count');

  const rStudent=$('rStudent'), from=$('from'), to=$('to'), rType=$('rType'), rLen=$('rLen');
  const copyReport=$('copyReport'), reportPreview=$('reportPreview'), dump=$('dump'), rangeInfo=$('rangeInfo');
  const downloadDoc=$('downloadDoc'), printBtn=$('print');

  const exportBtn=$('export'), importBtn=$('importBtn'), importFile=$('importFile'), wipe=$('wipe');
  const toast=$('toast');

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display='block';
    clearTimeout(showToast.t);
    showToast.t=setTimeout(()=>toast.style.display='none',1600);
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    return new Date(d.getTime()-off*60000).toISOString().slice(0,10);
  }

  function save(){ localStorage.setItem(LS, JSON.stringify(state)); }
  function load(){
    try { return JSON.parse(localStorage.getItem(LS)); } catch { return null; }
  }

  function normalizeBullets(text){
    return (text||'').split('\n').map(s=>s.trim()).filter(Boolean).map(s=>s.replace(/^[-•\u2022]\s*/,''));
  }

  function buildDailyPrompt(obj){
    const b = normalizeBullets(obj.topics);
    const topicsBlock = b.length ? b.map(x=>`- ${x}`).join('\n') : (obj.topics||'').trim() || "- (konu girilmedi)";
    const obsText = (obj.obs||'').trim() || "(gözlem girilmedi)";
    const nextText = (obj.next||'').trim() || "(hedef girilmedi)";
    return `Aşağıdaki ham seans verilerini kullanarak Türkçe bir “Günlük Seans Notu” yaz.

Kriterler:
- Akademik ama samimi bir ton kullan.
- Özgün cümleler kur; tekrar eden kalıp ifadelerden kaçın.
- Mümkünse tek paragraf (en fazla 2 kısa paragraf).
- Son cümlede bir sonraki odak/hedefi belirt.
- Öğrenci adı ve tarih metinde geçsin.

HAM VERİ:
Öğrenci: ${obj.student}
Tarih: ${obj.date}

Çalışılan Konular:
${topicsBlock}

Kısa Gözlem:
${obsText}

Bir Sonraki Odak/Hedef:
${nextText}
`;
  }

  function inRange(d, f, t){
    if (f && d < f) return false;
    if (t && d > t) return false;
    return true;
  }

  function getRangeSessions(){
    const who = rStudent.value;
    return state.sessions
      .filter(s => who === '__ALL__' ? true : s.student === who)
      .filter(s => inRange(s.date, from.value, to.value))
      .sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  }

  function dumpText(list){
    if (!list.length) return "(Seçilen aralıkta kayıt yok.)";
    return list.map(s=>{
      const b = normalizeBullets(s.topics);
      const t = b.length ? b.map(x=>`- ${x}`).join('\n') : (s.topics||'').trim() || "- (boş)";
      return `Tarih: ${s.date}
Öğrenci: ${s.student}
Konular:
${t}
Gözlem:
${(s.obs||'').trim() || "(boş)"}
Hedef:
${(s.next||'').trim() || "(boş)"}
---`;
    }).join('\n\n');
  }

  function buildReportPrompt(){
    const list = getRangeSessions();
    const who = rStudent.value === '__ALL__' ? 'TÜM ÖĞRENCİLER' : rStudent.value;
    const f = from.value || "(başlangıç yok)";
    const t = to.value || "(bitiş yok)";
    const len = rLen.value === 'short' ? 'Kısa (6-10 cümle).' : rLen.value === 'long' ? 'Detaylı (2-4 paragraf).' : 'Orta (1-2 paragraf).';

    if (rType.value === 'raw'){
      return `Aşağıdaki seans kayıtlarını yorum eklemeden düzenle (Tarih/Öğrenci/Konular/Gözlem/Hedef).

KAPSAM: ${who} | ${f} – ${t}

KAYITLAR:
${dumpText(list)}
`;
    }

    const goal = rType.value === 'weekly' ? 'Haftalık özet yaz.' : rType.value === 'monthly' ? 'Aylık eğilimleri değerlendir.' : 'Gelişim değerlendirmesi yaz.';
    return `Aşağıdaki seans kayıtlarına dayanarak Türkçe bir rapor yaz.

Amaç: ${goal}
Uzunluk: ${len}
Dil: akademik ama samimi; tekrar eden kalıplardan kaçın.
Sonunda 3-5 maddelik “Önerilen bir sonraki odaklar” ekle.

KAPSAM: ${who} | ${f} – ${t}

HAM KAYITLAR:
${dumpText(list)}
`;
  }

  async function copy(text){
    try { await navigator.clipboard.writeText(text); showToast("Kopyalandı."); }
    catch { showToast("Kopyalanamadı (izin)."); }
  }

  function renderStudents(){
    student.innerHTML='';
    state.students.forEach((s,i)=>{
      const o=document.createElement('option');
      o.value=s; o.textContent=s;
      if (i===0) o.disabled=true;
      student.appendChild(o);
    });
    if (state.students.includes(localStorage.getItem('lastStudent'))) student.value = localStorage.getItem('lastStudent');

    rStudent.innerHTML='';
    const all=document.createElement('option'); all.value='__ALL__'; all.textContent='Tümü';
    rStudent.appendChild(all);
    state.students.slice(1).forEach(s=>{
      const o=document.createElement('option');
      o.value=s; o.textContent=s;
      rStudent.appendChild(o);
    });
  }

  function renderDailyPreview(){
    const obj = { student: student.value, date: date.value, topics: topics.value, obs: obs.value, next: next.value };
    dailyPreview.textContent = buildDailyPrompt(obj);
  }

  function renderList(){
    const q=(search.value||'').trim().toLowerCase();
    let arr=[...state.sessions];
    if (q) arr=arr.filter(s => (s.student||'').toLowerCase().includes(q) || (s.date||'').includes(q));
    arr.sort((a,b)=> sort.value==='new' ? (b.date||'').localeCompare(a.date||'') : (a.date||'').localeCompare(b.date||''));
    count.textContent = `${arr.length} kayıt gösteriliyor (toplam ${state.sessions.length}).`;
    list.innerHTML='';
    if (!arr.length){ list.innerHTML = `<div class="muted">Kayıt yok.</div>`; return; }

    arr.forEach(s=>{
      const div=document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <h3>${s.student} <span class="muted">· ${s.date}</span></h3>
        <div class="meta"><span>ID: ${s.id.slice(0,6)}</span></div>
        <div class="twoBtns">
          <button class="btn" data-act="edit" data-id="${s.id}">Düzenle</button>
          <button class="btn" data-act="copy" data-id="${s.id}">Prompt</button>
          <button class="btn danger" data-act="del" data-id="${s.id}">Sil</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function renderReport(){
    const r = getRangeSessions();
    rangeInfo.textContent = `${rStudent.value==='__ALL__'?'Tümü':rStudent.value} | ${from.value||'-'} → ${to.value||'-'} | ${r.length} kayıt`;
    dump.textContent = dumpText(r);
    reportPreview.textContent = buildReportPrompt();
  }

  // tabs
  tabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.toggle('active', x===t));
      ['daily','report','backup'].forEach(id => $(id).classList.toggle('hide', id !== t.dataset.tab));
      renderReport();
    });
  });

  // init
  date.value = todayISO();
  to.value = todayISO();
  const d=new Date(); d.setDate(d.getDate()-7);
  const off=d.getTimezoneOffset();
  from.value = new Date(d.getTime()-off*60000).toISOString().slice(0,10);

  renderStudents();
  renderDailyPreview();
  renderList();
  renderReport();

  // events
  student.addEventListener('change', ()=>{ localStorage.setItem('lastStudent', student.value); renderDailyPreview(); });
  [date,topics,obs,next].forEach(el=>el.addEventListener('input', renderDailyPreview));

  addStudent.addEventListener('click', ()=>{
    const n=(newStudent.value||'').trim();
    if(!n) return showToast("Öğrenci adı yaz.");
    if(state.students.includes(n)) return showToast("Zaten var.");
    state.students.push(n); newStudent.value='';
    save(); renderStudents(); student.value=n; localStorage.setItem('lastStudent', n);
    showToast("Eklendi."); renderDailyPreview(); renderReport();
  });

  delStudent.addEventListener('click', ()=>{
    if(student.value==='Öğrenci Seç') return showToast("Öğrenci seç.");
    state.students = state.students.filter(x=>x!==student.value);
    save(); renderStudents(); student.value='Öğrenci Seç';
    showToast("Silindi."); renderDailyPreview(); renderReport();
  });

  saveBtn.addEventListener('click', ()=>{
    if(student.value==='Öğrenci Seç') return showToast("Öğrenci seç.");
    const obj={ id: Math.random().toString(16).slice(2)+Date.now().toString(16),
      student: student.value, date: date.value, topics: topics.value, obs: obs.value, next: next.value };
    state.sessions.push(obj); save(); renderList(); renderReport(); showToast("Kaydedildi.");
  });

  copyDaily.addEventListener('click', ()=> copy(dailyPreview.textContent));
  clearBtn.addEventListener('click', ()=>{ topics.value=''; obs.value=''; next.value=''; renderDailyPreview(); showToast("Temizlendi."); });

  search.addEventListener('input', renderList);
  sort.addEventListener('change', renderList);

  list.addEventListener('click', (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id, act=b.dataset.act;
    const i=state.sessions.findIndex(x=>x.id===id); if(i<0) return;
    const s=state.sessions[i];
    if(act==='del'){ state.sessions.splice(i,1); save(); renderList(); renderReport(); showToast("Silindi."); }
    if(act==='copy'){ copy(buildDailyPrompt(s)); }
    if(act==='edit'){
      student.value=s.student; date.value=s.date; topics.value=s.topics||''; obs.value=s.obs||''; next.value=s.next||'';
      localStorage.setItem('lastStudent', s.student);
      renderDailyPreview(); showToast("Forma yüklendi.");
    }
  });

  [rStudent,from,to,rType,rLen].forEach(el=>{
    el.addEventListener('change', renderReport);
    el.addEventListener('input', renderReport);
  });

  copyReport.addEventListener('click', ()=> copy(buildReportPrompt()));

  // Word(.doc)
  downloadDoc.addEventListener('click', ()=>{
    const r=getRangeSessions();
    const title=`SeansDokumu_${rStudent.value==='__ALL__'?'Tum':rStudent.value}_${from.value||'x'}_${to.value||'y'}`;
    const body = r.length ? r.map(s=>{
      const b=normalizeBullets(s.topics);
      const topicsHtml = b.length ? `<ul>${b.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<p>${escapeHtml((s.topics||'').trim()||'(boş)')}</p>`;
      return `<h3>${escapeHtml(s.student)} — ${escapeHtml(s.date)}</h3>
      <p><b>Konular:</b></p>${topicsHtml}
      <p><b>Gözlem:</b> ${escapeHtml((s.obs||'').trim()||'(boş)')}</p>
      <p><b>Hedef:</b> ${escapeHtml((s.next||'').trim()||'(boş)')}</p><hr/>`;
    }).join('') : `<p>(Kayıt yok)</p>`;

    const html = `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title></head>
    <body style="font-family:Times New Roman,serif;font-size:12pt;line-height:1.35">${body}</body></html>`;

    const blob=new Blob([html],{type:'application/msword'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`${title}.doc`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),800);
    showToast("Word indirildi.");
  });

  function escapeHtml(str){
    return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  // PDF print
  printBtn.addEventListener('click', ()=>{
    const r=getRangeSessions();
    const html = `<html><head><meta charset="utf-8"><title>Seans Dökümü</title></head>
      <body style="font-family:Times New Roman,serif;font-size:12pt;line-height:1.35;padding:16px">
      <h2>Seans Dökümü</h2><div>${escapeHtml(rangeInfo.textContent)}</div><hr/>
      <pre style="white-space:pre-wrap">${escapeHtml(dumpText(r))}</pre>
      </body></html>`;
    const w=window.open('','_blank'); if(!w) return showToast("Pop-up engellendi.");
    w.document.open(); w.document.write(html); w.document.close(); w.focus();
    setTimeout(()=>w.print(),300);
  });

  // Backup
  exportBtn.addEventListener('click', ()=>{
    const data = JSON.stringify(state, null, 2);
    const blob=new Blob([data],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`seansnotu_yedek_${todayISO()}.json`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),800);
    showToast("Yedek indirildi.");
  });

  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', async ()=>{
    const f=importFile.files && importFile.files[0]; if(!f) return;
    try{
      const text = await f.text();
      const incoming = JSON.parse(text);
      if(!incoming.students || !incoming.sessions) throw new Error();
      state.students = Array.from(new Set([...state.students, ...incoming.students]));
      state.sessions = [...state.sessions, ...incoming.sessions];
      save(); renderStudents(); renderList(); renderReport();
      showToast("İçe aktarıldı.");
    }catch{ showToast("JSON hatalı."); }
    importFile.value='';
  });

  wipe.addEventListener('click', ()=>{
    if(!confirm("Tüm veriler silinsin mi?")) return;
    localStorage.removeItem(LS);
    location.reload();
  });
})();
</script>
</body>
</html>
